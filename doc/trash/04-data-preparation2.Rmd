---
title: "Data Preparation "
subtitle: "cas415"
author: "pbrunier@cogne.com"
version: 1.0 
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    css: ./custom.css
    df_print: paged
    gallery: no
    highlight: default
    html_document: null
    lightbox: yes
    number_sections: yes
    self_contained: yes
    thumbnails: no
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      fig.height = 7,
                      fig.width = 10,
                      collapse = TRUE,
                      cols.print=20)
rm(list = ls(all.names = TRUE))

require(dplyr)
require(kableExtra)
require(readr)
source('~/dev/cas415/R/function.R')
```

# File

Ci siamo dimenticati di mettere i data type

```{r aserty}
col_type <- paste('ic',paste(rep('d',26),collapse = ''),sep = '')
```

leggiamo i dati 

```{r zerty}
carmet415M3 <- read_delim('/data/cas415/carmet_2.txt',
                          delim = '\t',
                          skip = 0,
                          #col_names = col_name,
                          col_types = col_type,
                          n_max = Inf,
                          na = c("",-1, "NA")) #sostituire -1 con NA
```


elimino le righe dove Rm_mean < 500 perche Vincenzo ha detto che sono valori impossibili

```{r hfk}
carmet415M3 <- carmet415M3 %>% 
  filter(Rm_mean>500)
```

ricalcolo le specifiche in base alla numerosit√† campionaria

```{r shsg}
usl <- 1100
lsl <- 900
center <- 1000
delta2 <- (usl-lsl)/2
carmet415M3 <- carmet415M3 %>% 
  mutate(Rm_usl=center+delta2/sqrt(Rm_count),
         Rm_lsl=center-delta2/sqrt(Rm_count),
         Rm_center=center)
```

fuori specifica

```{r ala}
carmet415M3 <- carmet415M3 %>% 
  mutate(Rm_test1=ifelse(Rm_mean>Rm_usl|Rm_mean<Rm_lsl,'failed','passed'))
```


riordino variabili

```{r djfbs}
carmet415M3 <- carmet415M3 %>% 
  select(-starts_with('Rp02_')) %>% 
  select(anno, colata, starts_with('Rm_'),everything())
```

aggiugo indici di riga nella prima colonna

```{r dsjfkwj}
carmet415M3 <- carmet415M3 %>% 
  mutate(index = row_number()) %>% 
  select(index, everything())
```

contiamo le righe 

```{r serty}
nrow(carmet415M3)
```

salva rds

```{r xerty}
write_rds(carmet415M3,'/data/cas415/carmet415M3.rds')
```